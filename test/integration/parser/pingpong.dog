#!/usr/bin/env dog

IMPORT CONFIG "config.yaml"
IMPORT FUNCTION "matching.rb" AS matching
IMPORT COMMUNITY "media_lab" AS media_lab
IMPORT MESSAGE "you_are_on_the_waiting_list.message"
IMPORT MESSAGE "match_assignment.message"

LISTEN TO PUBLIC VIA http FOR home_page
LISTEN TO media_lab VIA http FOR game_page
LISTEN TO media_lab VIA http FOR game_requests

waiting_users = []

ON EACH request IN home_page DO
  NOTIFY PERSON FROM request VIA http_responst OF "index.erb"
END

ON EACH request IN game_page DO
  NOTIFY PERSON FROM request VIA http_response OF "game.erb"
END

ON EACH game_request DO
  user = PERSON FROM game_request
  IF waiting_users.count > 0 THEN
    matched_users = COMPUTE matching ON waiting_users, user
    NOTIFY matched_users VIA email OF match_assignment
  ELSE
    waiting_users = waiting_users UNION user
    NOTIFY user VIA http_response OF you_are_on_the_waiting_list
  END
END
